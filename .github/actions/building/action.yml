name: "Building"
description: "Compiles the project"

runs:
  using: "composite"
  steps:
    - name: Install system dependencies
      shell: bash
      run: |
        sudo apt-get update
        sudo apt-get install -y build-essential cmake git libmicrohttpd-dev libcjson-dev python3-pip

    - name: Install Conan
      shell: bash
      run: pip install --user conan

    - name: Configure Conan
      shell: bash
      run: conan profile detect --force

    - name: Install dependencies with Conan
      shell: bash
      run: conan install . --output-folder=build --build=missing

    - name: Configure main project
      shell: bash
      run: |
        mkdir -p build
        cmake -S . -B build \
              -DCMAKE_TOOLCHAIN_FILE=$(pwd)/build/Release/generators/conan_toolchain.cmake \
              -DCMAKE_PREFIX_PATH=$(pwd)/build/Release/generators \
              -DCMAKE_BUILD_TYPE=Release

    - name: Build main project
      shell: bash
      run: cmake --build build -- -j$(nproc)

    - name: Clone prometheus client
      shell: bash
      run: |
        git clone https://github.com/digitalocean/prometheus-client-c.git
        cd prometheus-client-c
        rm -rf promhttp

    - name: Building and Installing Prometheus
      shell: bash
      run: |
        cd prometheus-client-c/prom
        mkdir -p build
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Release
        cmake --build build -- -j$(nproc)
        sudo cmake --install build
